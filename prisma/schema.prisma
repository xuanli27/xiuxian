generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

// ==================== 用户系统 ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  emailVerified DateTime?
  image         String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  player   Player?
  accounts Account[]
  sessions Session[]
  
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("sessions")
}

// ==================== 游戏核心 ====================

enum Rank {
  MORTAL
  QI_REFINING
  FOUNDATION
  GOLDEN_CORE
  NASCENT_SOUL
  SPIRIT_SEVERING
  VOID_REFINING
  MAHAYANA
  IMMORTAL
}

enum SectRank {
  OUTER
  INNER
  ELITE
  ELDER
  MASTER
}

enum SpiritRootType {
  HEAVEN
  EARTH
  HUMAN
  WASTE
}

model Player {
  id     Int    @id @default(autoincrement())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 基础信息
  name   String
  avatar String?
  
  // 修为信息
  rank     Rank     @default(MORTAL)
  sectRank SectRank @default(OUTER)
  level    Int      @default(1)
  qi       Float    @default(0)
  maxQi    Float    @default(100)
  
  // 资质与心性
  spiritRoot SpiritRootType @default(WASTE)
  mindState  String          @default("刚入职")
  
  // 资源
  innerDemon    Float @default(0)
  contribution  Int   @default(0)
  spiritStones  Int   @default(0)
  caveLevel     Int   @default(1)
  
  // JSON字段
  inventory Json @default("{}")
  equipped  Json @default("{}")
  materials Json @default("{}")
  history   Json @default("[]")
  
  // 时间戳
  createTime    DateTime @default(now())
  lastLoginTime DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  tasks             Task[]
  leaderboardEntry  Leaderboard[]
  eventLogs         EventLog[]
  statusEffects     PlayerStatusEffect[]
  sectMembership    SectMember?

  @@index([rank, level])
  @@map("players")
}

// ==================== 宗门系统 ====================

model Sect {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  
  level       Int      @default(1)
  reputation  Int      @default(0)
  
  leaderId    Int      @unique
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     SectMember[]

  @@map("sects")
}

model SectMember {
  id        String   @id @default(cuid())
  playerId  Int      @unique
  sectId    String
  
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  sect      Sect     @relation(fields: [sectId], references: [id], onDelete: Cascade)

  rank      SectRank @default(OUTER)
  joinedAt  DateTime @default(now())

  @@map("sect_members")
}

// ==================== 任务系统 ====================

enum TaskType {
  LINK
  GAME
  BATTLE
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum TaskDifficulty {
  EASY
  MEDIUM
  HARD
}

enum TaskCategory {
  DAILY
  WEEKLY
  ACHIEVEMENT
}

model Task {
  id          String @id @default(cuid())
  playerId    Int
  player      Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  title       String
  description String
  type        TaskType
  difficulty  TaskDifficulty @default(EASY)
  category    TaskCategory   @default(DAILY)
  
  // 奖励
  rewardQi          Int
  rewardContribution Int
  rewardStones      Int
  
  duration Int
  status   TaskStatus @default(PENDING)
  
  url   String?
  quiz  Json?
  enemy Json?
  
  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  acceptedAt  DateTime?
  
  @@index([playerId, status])
  @@map("tasks")
}

// ==================== 排行榜 ====================

model Season {
  id        String   @id
  name      String
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(false)

  leaderboardEntries Leaderboard[]

  @@map("seasons")
}

model Leaderboard {
  id           String   @id @default(cuid())
  playerId     Int
  seasonId     String
  
  player       Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  season       Season   @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  playerName   String
  playerAvatar String?
  rank         Rank
  level        Int
  
  // Scores for different categories
  realmScore        BigInt @default(0) // 境界得分
  powerScore        BigInt @default(0) // 战力得分 (临时用贡献)
  wealthScore       BigInt @default(0) // 财富得分
  contributionScore BigInt @default(0) // 贡献得分

  updatedAt DateTime @updatedAt

  @@unique([playerId, seasonId])
  @@index([seasonId, realmScore])
  @@index([seasonId, powerScore])
  @@index([seasonId, wealthScore])
  @@index([seasonId, contributionScore])
  @@map("leaderboard")
}

// ==================== 事件流系统 ====================

enum EventType {
  MAJOR
  MINOR
  CHAIN
}

model EventLog {
  id        String   @id @default(cuid())
  playerId  Int
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  eventId   String
  eventType EventType
  title     String
  description String @db.Text
  
  choiceId  String?
  choiceText String?
  
  result    Json
  
  createdAt DateTime @default(now())
  
  @@index([playerId, createdAt])
  @@map("event_logs")
}

model PlayerStatusEffect {
  id        String   @id @default(cuid())
  playerId  Int
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  effectId  String
  name      String
  description String
  
  modifiers Json
  
  startedAt DateTime @default(now())
  expiresAt DateTime?
  
  @@index([playerId, expiresAt])
  @@map("player_status_effects")
}