# 摸鱼修仙录 - 项目改造计划

> 制定日期: 2025-11-18  
> 项目类型: 修仙养成类放置游戏  
> 改造目标: 结构优化 + 功能完善 + 质量提升

---

## 🎯 改造目标

### 核心目标
1. **修复阻塞性问题** - 确保项目可运行
2. **优化项目结构** - 提升可维护性
3. **完善核心功能** - 提升用户体验
4. **建立质量保障** - 确保代码质量

### 成功标准
- ✅ 所有P0问题已修复
- ✅ 项目结构清晰合理
- ✅ 核心功能完整可用
- ✅ 代码质量达标
- ✅ 可以顺利部署上线

---

## 📋 改造阶段规划

### 阶段一：紧急修复（Day 1，4小时）

#### 1.1 数据库Schema统一 ⏰ 1.5小时

**任务**: 统一使用修仙术语，修复字段不匹配问题

**执行步骤**:
1. 备份当前数据库
2. 修改 `prisma/schema.prisma`
3. 运行 `pnpm db:push`
4. 运行 `pnpm db:generate`
5. 更新所有引用字段的代码

**关键修改**:
- 保持 `realm`, `qi`, `maxQi` 字段
- 添加 `realmLevel` 字段
- 确保所有代码使用一致的字段名

---

#### 1.2 环境配置 ⏰ 30分钟

**任务清单**:
```bash
cp .env.example .env
# 配置必需变量：
# - DATABASE_URL
# - NEXTAUTH_SECRET
# - GOOGLE_API_KEY
```

---

#### 1.3 数据库初始化 ⏰ 30分钟

```bash
pnpm db:push
pnpm db:generate
pnpm db:studio  # 验证
```

---

#### 1.4 基础功能测试 ⏰ 1小时

**测试清单**:
- [ ] 启动开发服务器
- [ ] 测试登录流程
- [ ] 测试Dashboard显示
- [ ] 测试任务系统
- [ ] 测试修炼系统

---

### 阶段二：结构优化（Day 2-3，2天）

#### 2.1 清理旧文件 ⏰ 1小时

```bash
rm App.tsx index.tsx index.html metadata.json
rm -rf store/  # 统一使用stores/
```

---

#### 2.2 组件集成到路由 ⏰ 3小时

**任务**:
1. 集成 CaveManager 到 `app/(game)/cave/page.tsx`
2. 集成 SectHall 到 `app/(game)/sect/page.tsx`
3. 创建 `app/(auth)/onboarding/page.tsx` 新手引导

---

#### 2.3 补充路由保护 ⏰ 30分钟

更新 `middleware.ts`，添加所有游戏路由保护

---

#### 2.4 合并配置文件 ⏰ 2小时

统一配置到 `config/` 目录

---

### 阶段三：功能完善（Day 4-7，4天）

#### 3.1 实现关键TODO ⏰ 2天

**优先级**:
1. 境界升级逻辑
2. 物品效果逻辑
3. 建筑限制检查
4. 其他优化项

---

#### 3.2 完善游戏平衡性 ⏰ 1天

调整：
- 境界经验需求
- 任务奖励
- 突破成功率
- 物品效果

---

#### 3.3 优化用户体验 ⏰ 1天

添加：
- 加载状态 (loading.tsx)
- 错误边界 (error.tsx)
- 动画优化
- 移动端适配

---

### 阶段四：质量保障（Week 2，1周）

#### 4.1 配置测试框架 ⏰ 4小时

安装 Vitest + Testing Library

---

#### 4.2 编写单元测试 ⏰ 2天

目标覆盖率 >60%

优先测试：
- 工具函数
- Server Actions
- 数据查询
- UI组件

---

#### 4.3 编写集成测试 ⏰ 1天

测试场景：
- 用户注册流程
- 新手引导流程
- 任务完成流程
- 修炼突破流程

---

#### 4.4 性能优化 ⏰ 1天

- 数据库查询优化
- 组件渲染优化
- 图片优化
- 代码分割
- 缓存策略

---

#### 4.5 安全加固 ⏰ 1天

- 完善权限检查
- 输入验证
- CSRF保护
- 速率限制
- 安全响应头

---

### 阶段五：部署准备（Week 3，3天）

#### 5.1 环境配置 ⏰ 4小时

配置生产环境变量

---

#### 5.2 数据库迁移 ⏰ 2小时

```bash
pnpm db:migrate deploy
pnpm db:seed
```

---

#### 5.3 构建和测试 ⏰ 4小时

```bash
pnpm build
pnpm start
pnpm test
pnpm lint
```

---

#### 5.4 部署文档 ⏰ 2小时

创建 `docs/DEPLOYMENT.md`

---

## 📊 进度跟踪

### 里程碑

| 阶段 | 目标 | 预计时间 | 状态 |
|------|------|----------|------|
| 阶段一 | 紧急修复 | Day 1 | ⏳ 待开始 |
| 阶段二 | 结构优化 | Day 2-3 | ⏳ 待开始 |
| 阶段三 | 功能完善 | Day 4-7 | ⏳ 待开始 |
| 阶段四 | 质量保障 | Week 2 | ⏳ 待开始 |
| 阶段五 | 部署准备 | Week 3 | ⏳ 待开始 |

### 关键指标

- **代码质量**: 测试覆盖率 >60%
- **性能指标**: 首屏加载 <2s
- **用户体验**: 核心流程完整
- **安全性**: 通过安全审计

---

## 🎯 下一步行动

### 立即开始

1. **阶段一第一步**: 修复数据库Schema
2. **准备工作**: 配置开发环境
3. **团队协作**: 分配任务和责任

### 需要决策

- [ ] 选择部署平台（Vercel/Railway/自托管）
- [ ] 确定测试策略
- [ ] 确定发布时间表

---

**文档维护**: 随着改造进展更新此文档  
**下次审查**: 完成阶段一后