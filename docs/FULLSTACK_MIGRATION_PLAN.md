# ğŸš€ æ‘¸é±¼ä¿®ä»™å½• - å…¨æ ˆæ¶æ„è¿ç§»æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

å°†**æ‘¸é±¼ä¿®ä»™å½•**ä»çº¯å‰ç«¯é¡¹ç›®å‡çº§ä¸º**å‰åç«¯ä¸€ä½“åŒ–çš„å…¨æ ˆåº”ç”¨**ï¼ŒåŸºäº **Next.js 15 App Router** + **Vercel AI SDK** + **PostgreSQL** + **NextAuth.js**ï¼Œå®ç°ç”¨æˆ·è®¤è¯ã€æ•°æ®æŒä¹…åŒ–ã€æœåŠ¡ç«¯æ¸²æŸ“ç­‰å®Œæ•´åŠŸèƒ½ã€‚

---

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

### åŠŸèƒ½ç›®æ ‡
1. âœ… **ç”¨æˆ·ç³»ç»Ÿ**: æ³¨å†Œã€ç™»å½•ã€OAuthè®¤è¯
2. âœ… **æ•°æ®æŒä¹…åŒ–**: æ¸¸æˆè¿›åº¦äº‘ç«¯ä¿å­˜
3. âœ… **æœåŠ¡ç«¯æ¸²æŸ“**: SEOä¼˜åŒ–ã€æ€§èƒ½æå‡
4. âœ… **AIé›†æˆ**: Vercel AI SDK + Gemini API
5. âœ… **å®æ—¶åŒæ­¥**: è·¨è®¾å¤‡æ¸¸æˆè¿›åº¦åŒæ­¥
6. âœ… **ç¤¾äº¤åŠŸèƒ½**: æ’è¡Œæ¦œã€å®—é—¨äº’åŠ¨

### æŠ€æœ¯æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend: Next.js 15 (App Router + RSC)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Auth: NextAuth.js v5 (Google/GitHub OAuth)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  API: Next.js Server Actions + API Routes           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Database: PostgreSQL (Vercel Postgres)             â”‚
â”‚  ORM: Drizzle ORM                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AI: Vercel AI SDK + Google Gemini                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  State: Zustand (Local) + Server State (Tanstack)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Deployment: Vercel                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ å…¨æ ˆæ¶æ„è®¾è®¡

### 1. ç›®å½•ç»“æ„

```
xiuxian-nextjs/
â”œâ”€â”€ app/                              # Next.js App Router
â”‚   â”œâ”€â”€ (auth)/                      # è®¤è¯è·¯ç”±ç»„
â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx             # ç™»å½•é¡µ
â”‚   â”‚   â”œâ”€â”€ register/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx             # æ³¨å†Œé¡µ
â”‚   â”‚   â””â”€â”€ layout.tsx               # è®¤è¯å¸ƒå±€
â”‚   â”‚
â”‚   â”œâ”€â”€ (game)/                      # æ¸¸æˆè·¯ç”±ç»„ (éœ€è¦è®¤è¯)
â”‚   â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”œâ”€â”€ tasks/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”œâ”€â”€ sect/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”œâ”€â”€ inventory/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”œâ”€â”€ cave/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ layout.tsx               # æ¸¸æˆå¸ƒå±€ (å«å¯¼èˆªæ )
â”‚   â”‚
â”‚   â”œâ”€â”€ (landing)/                   # è½åœ°é¡µè·¯ç”±ç»„
â”‚   â”‚   â”œâ”€â”€ page.tsx                 # é¦–é¡µ
â”‚   â”‚   â”œâ”€â”€ about/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ layout.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                         # API Routes
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â””â”€â”€ [...nextauth]/
â”‚   â”‚   â”‚       â””â”€â”€ route.ts         # NextAuthé…ç½®
â”‚   â”‚   â”œâ”€â”€ ai/
â”‚   â”‚   â”‚   â”œâ”€â”€ feedback/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts         # AIåé¦ˆAPI
â”‚   â”‚   â”‚   â””â”€â”€ stream/
â”‚   â”‚   â”‚       â””â”€â”€ route.ts         # AIæµå¼API
â”‚   â”‚   â””â”€â”€ leaderboard/
â”‚   â”‚       â””â”€â”€ route.ts             # æ’è¡Œæ¦œAPI
â”‚   â”‚
â”‚   â”œâ”€â”€ actions/                     # Server Actions
â”‚   â”‚   â”œâ”€â”€ auth.ts                  # è®¤è¯ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ player.ts                # ç©å®¶æ•°æ®CRUD
â”‚   â”‚   â”œâ”€â”€ game.ts                  # æ¸¸æˆé€»è¾‘
â”‚   â”‚   â”œâ”€â”€ ai.ts                    # AIç”Ÿæˆ
â”‚   â”‚   â””â”€â”€ leaderboard.ts           # æ’è¡Œæ¦œ
â”‚   â”‚
â”‚   â”œâ”€â”€ layout.tsx                   # æ ¹å¸ƒå±€
â”‚   â”œâ”€â”€ providers.tsx                # å…¨å±€Providers
â”‚   â””â”€â”€ globals.css                  # å…¨å±€æ ·å¼
â”‚
â”œâ”€â”€ components/                       # UIç»„ä»¶
â”‚   â”œâ”€â”€ ui/                          # åŸºç¡€ç»„ä»¶
â”‚   â”œâ”€â”€ auth/                        # è®¤è¯ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ LoginForm.tsx
â”‚   â”‚   â”œâ”€â”€ RegisterForm.tsx
â”‚   â”‚   â””â”€â”€ AuthProvider.tsx
â”‚   â”œâ”€â”€ landing/                     # è½åœ°é¡µç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ Hero.tsx
â”‚   â”‚   â”œâ”€â”€ Features.tsx
â”‚   â”‚   â””â”€â”€ CTA.tsx
â”‚   â”œâ”€â”€ onboarding/
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ tasks/
â”‚   â”œâ”€â”€ sect/
â”‚   â”œâ”€â”€ inventory/
â”‚   â”œâ”€â”€ cave/
â”‚   â””â”€â”€ tribulation/
â”‚
â”œâ”€â”€ lib/                              # æ ¸å¿ƒåº“
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ auth.ts                  # NextAuthé…ç½®
â”‚   â”‚   â”œâ”€â”€ auth-options.ts          # Authé€‰é¡¹
â”‚   â”‚   â””â”€â”€ session.ts               # Sessionå·¥å…·
â”‚   â”‚
â”‚   â”œâ”€â”€ db/                          # æ•°æ®åº“
â”‚   â”‚   â”œâ”€â”€ index.ts                 # Drizzleå®ä¾‹
â”‚   â”‚   â”œâ”€â”€ schema.ts                # æ•°æ®åº“Schema
â”‚   â”‚   â”œâ”€â”€ migrations/              # æ•°æ®åº“è¿ç§»
â”‚   â”‚   â””â”€â”€ queries/                 # æŸ¥è¯¢å‡½æ•°
â”‚   â”‚       â”œâ”€â”€ player.ts
â”‚   â”‚       â”œâ”€â”€ game.ts
â”‚   â”‚       â””â”€â”€ leaderboard.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ ai/                          # AIæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ gemini.ts                # Gemini Provider
â”‚   â”‚   â”œâ”€â”€ prompts.ts               # Promptæ¨¡æ¿
â”‚   â”‚   â””â”€â”€ tools.ts                 # AI Tools
â”‚   â”‚
â”‚   â”œâ”€â”€ game/                        # æ¸¸æˆé€»è¾‘
â”‚   â”‚   â”œâ”€â”€ calculations.ts          # æ•°å€¼è®¡ç®—
â”‚   â”‚   â”œâ”€â”€ constants.ts             # æ¸¸æˆå¸¸é‡
â”‚   â”‚   â””â”€â”€ utils.ts                 # æ¸¸æˆå·¥å…·
â”‚   â”‚
â”‚   â””â”€â”€ utils.ts                     # é€šç”¨å·¥å…·
â”‚
â”œâ”€â”€ store/                            # å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç†
â”‚   â””â”€â”€ useGameStore.ts              # Zustand Store
â”‚
â”œâ”€â”€ types/                            # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ auth.ts
â”‚   â”œâ”€â”€ game.ts
â”‚   â”œâ”€â”€ database.ts
â”‚   â””â”€â”€ index.ts
â”‚
â”œâ”€â”€ hooks/                            # è‡ªå®šä¹‰Hooks
â”‚   â”œâ”€â”€ usePlayer.ts                 # ç©å®¶æ•°æ®Hook
â”‚   â”œâ”€â”€ useGame.ts                   # æ¸¸æˆé€»è¾‘Hook
â”‚   â””â”€â”€ useAI.ts                     # AIäº¤äº’Hook
â”‚
â”œâ”€â”€ middleware.ts                     # Next.jsä¸­é—´ä»¶ (è®¤è¯ä¿æŠ¤)
â”œâ”€â”€ drizzle.config.ts                # Drizzleé…ç½®
â”œâ”€â”€ next.config.ts                   # Next.jsé…ç½®
â”œâ”€â”€ tailwind.config.ts               # Tailwindé…ç½®
â”œâ”€â”€ .env.local                       # ç¯å¢ƒå˜é‡
â””â”€â”€ package.json
```

---

## ğŸ’¾ æ•°æ®åº“è®¾è®¡

### Schemaå®šä¹‰ (Drizzle ORM)

```typescript
// lib/db/schema.ts
import { pgTable, varchar, integer, timestamp, jsonb, boolean, serial, index } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';

// ç”¨æˆ·è¡¨
export const users = pgTable('users', {
  id: varchar('id', { length: 255 }).primaryKey(),
  email: varchar('email', { length: 255 }).unique().notNull(),
  name: varchar('name', { length: 255 }),
  emailVerified: timestamp('email_verified'),
  image: varchar('image', { length: 512 }),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// è´¦æˆ·è¡¨ (OAuth)
export const accounts = pgTable('accounts', {
  id: varchar('id', { length: 255 }).primaryKey(),
  userId: varchar('user_id', { length: 255 }).notNull().references(() => users.id, { onDelete: 'cascade' }),
  type: varchar('type', { length: 255 }).notNull(),
  provider: varchar('provider', { length: 255 }).notNull(),
  providerAccountId: varchar('provider_account_id', { length: 255 }).notNull(),
  refresh_token: varchar('refresh_token', { length: 512 }),
  access_token: varchar('access_token', { length: 512 }),
  expires_at: integer('expires_at'),
  token_type: varchar('token_type', { length: 255 }),
  scope: varchar('scope', { length: 255 }),
  id_token: varchar('id_token', { length: 2048 }),
  session_state: varchar('session_state', { length: 255 }),
});

// ä¼šè¯è¡¨
export const sessions = pgTable('sessions', {
  id: varchar('id', { length: 255 }).primaryKey(),
  sessionToken: varchar('session_token', { length: 255 }).unique().notNull(),
  userId: varchar('user_id', { length: 255 }).notNull().references(() => users.id, { onDelete: 'cascade' }),
  expires: timestamp('expires').notNull(),
});

// ç©å®¶æ•°æ®è¡¨
export const players = pgTable('players', {
  id: serial('id').primaryKey(),
  userId: varchar('user_id', { length: 255 }).unique().notNull().references(() => users.id, { onDelete: 'cascade' }),
  
  // åŸºç¡€å±æ€§
  name: varchar('name', { length: 100 }).notNull(),
  avatar: varchar('avatar', { length: 512 }),
  rank: varchar('rank', { length: 50 }).notNull().default('MORTAL'),
  level: integer('level').notNull().default(1),
  
  // èµ„æº
  qi: integer('qi').notNull().default(0),
  maxQi: integer('max_qi').notNull().default(100),
  innerDemon: integer('inner_demon').notNull().default(0),
  contribution: integer('contribution').notNull().default(0),
  spiritStones: integer('spirit_stones').notNull().default(0),
  
  // æ¸¸æˆçŠ¶æ€
  spiritRoot: varchar('spirit_root', { length: 50 }).notNull().default('WASTE'),
  mindState: varchar('mind_state', { length: 100 }).notNull().default('åˆšå…¥èŒ'),
  sectRank: varchar('sect_rank', { length: 50 }).notNull().default('å¤–é—¨ç‰›é©¬'),
  caveLevel: integer('cave_level').notNull().default(1),
  location: varchar('location', { length: 100 }).notNull().default('å·¥ä½'),
  theme: varchar('theme', { length: 20 }).notNull().default('dark'),
  
  // JSONå­—æ®µ
  inventory: jsonb('inventory').notNull().default({}),
  equipped: jsonb('equipped').notNull().default({}),
  materials: jsonb('materials').notNull().default({}),
  history: jsonb('history').notNull().default([]),
  
  // æ—¶é—´æˆ³
  createTime: timestamp('create_time').defaultNow().notNull(),
  lastLoginTime: timestamp('last_login_time').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
}, (table) => {
  return {
    userIdIdx: index('player_user_id_idx').on(table.userId),
    rankIdx: index('player_rank_idx').on(table.rank),
    contributionIdx: index('player_contribution_idx').on(table.contribution),
  };
});

// ä»»åŠ¡è¡¨
export const tasks = pgTable('tasks', {
  id: serial('id').primaryKey(),
  playerId: integer('player_id').notNull().references(() => players.id, { onDelete: 'cascade' }),
  
  title: varchar('title', { length: 255 }).notNull(),
  description: varchar('description', { length: 512 }).notNull(),
  type: varchar('type', { length: 20 }).notNull(),
  
  reward: jsonb('reward').notNull(),
  duration: integer('duration').notNull(),
  completed: boolean('completed').notNull().default(false),
  
  url: varchar('url', { length: 512 }),
  quiz: jsonb('quiz'),
  enemy: jsonb('enemy'),
  
  createdAt: timestamp('created_at').defaultNow().notNull(),
  completedAt: timestamp('completed_at'),
}, (table) => {
  return {
    playerIdIdx: index('task_player_id_idx').on(table.playerId),
    completedIdx: index('task_completed_idx').on(table.completed),
  };
});

// æ’è¡Œæ¦œè¡¨ (ç”¨äºç¼“å­˜å’Œå†å²è®°å½•)
export const leaderboard = pgTable('leaderboard', {
  id: serial('id').primaryKey(),
  playerId: integer('player_id').notNull().references(() => players.id, { onDelete: 'cascade' }),
  playerName: varchar('player_name', { length: 100 }).notNull(),
  rank: varchar('rank', { length: 50 }).notNull(),
  level: integer('level').notNull(),
  contribution: integer('contribution').notNull(),
  score: integer('score').notNull(), // ç»¼åˆåˆ†æ•°
  
  season: varchar('season', { length: 50 }).notNull(), // èµ›å­£æ ‡è¯†
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
}, (table) => {
  return {
    seasonScoreIdx: index('leaderboard_season_score_idx').on(table.season, table.score),
    playerIdSeasonIdx: index('leaderboard_player_season_idx').on(table.playerId, table.season),
  };
});

// å…³ç³»å®šä¹‰
export const usersRelations = relations(users, ({ one, many }) => ({
  player: one(players),
  accounts: many(accounts),
  sessions: many(sessions),
}));

export const playersRelations = relations(players, ({ one, many }) => ({
  user: one(users, {
    fields: [players.userId],
    references: [users.id],
  }),
  tasks: many(tasks),
  leaderboardEntries: many(leaderboard),
}));

export const tasksRelations = relations(tasks, ({ one }) => ({
  player: one(players, {
    fields: [tasks.playerId],
    references: [players.id],
  }),
}));
```

---

## ğŸ” è®¤è¯ç³»ç»Ÿè®¾è®¡

### NextAuth.js v5 é…ç½®

```typescript
// lib/auth/auth.ts
import NextAuth from 'next-auth';
import Google from 'next-auth/providers/google';
import GitHub from 'next-auth/providers/github';
import { DrizzleAdapter } from '@auth/drizzle-adapter';
import { db } from '@/lib/db';

export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: DrizzleAdapter(db),
  providers: [
    Google({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
    GitHub({
      clientId: process.env.GITHUB_CLIENT_ID!,
      clientSecret: process.env.GITHUB_CLIENT_SECRET!,
    }),
  ],
  pages: {
    signIn: '/login',
    error: '/login',
  },
  callbacks: {
    async session({ session, user }) {
      if (session.user) {
        session.user.id = user.id;
      }
      return session;
    },
    async redirect({ url, baseUrl }) {
      // ç™»å½•åé‡å®šå‘åˆ°æ¸¸æˆä¸»é¡µ
      if (url.startsWith('/')) return `${baseUrl}${url}`;
      else if (new URL(url).origin === baseUrl) return url;
      return baseUrl + '/dashboard';
    },
  },
  session: {
    strategy: 'database',
    maxAge: 30 * 24 * 60 * 60, // 30 days
  },
});
```

### ä¸­é—´ä»¶ä¿æŠ¤

```typescript
// middleware.ts
import { auth } from '@/lib/auth/auth';
import { NextResponse } from 'next/server';

export default auth((req) => {
  const isLoggedIn = !!req.auth;
  const isGameRoute = req.nextUrl.pathname.startsWith('/dashboard') ||
                      req.nextUrl.pathname.startsWith('/tasks') ||
                      req.nextUrl.pathname.startsWith('/sect') ||
                      req.nextUrl.pathname.startsWith('/inventory') ||
                      req.nextUrl.pathname.startsWith('/cave');
  
  if (isGameRoute && !isLoggedIn) {
    return NextResponse.redirect(new URL('/login', req.url));
  }
  
  if (req.nextUrl.pathname.startsWith('/login') && isLoggedIn) {
    return NextResponse.redirect(new URL('/dashboard', req.url));
  }
  
  return NextResponse.next();
});

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
};
```

---

## ğŸ”Œ Server Actions APIè®¾è®¡

### ç©å®¶æ•°æ®ç®¡ç†

```typescript
// app/actions/player.ts
'use server';

import { auth } from '@/lib/auth/auth';
import { db } from '@/lib/db';
import { players } from '@/lib/db/schema';
import { eq } from 'drizzle-orm';
import { revalidatePath } from 'next/cache';

// è·å–ç©å®¶æ•°æ®
export async function getPlayerData() {
  const session = await auth();
  if (!session?.user?.id) {
    throw new Error('Unauthorized');
  }
  
  const [player] = await db
    .select()
    .from(players)
    .where(eq(players.userId, session.user.id))
    .limit(1);
  
  return player;
}

// æ›´æ–°ç©å®¶æ•°æ®
export async function updatePlayerData(updates: Partial<PlayerData>) {
  const session = await auth();
  if (!session?.user?.id) {
    throw new Error('Unauthorized');
  }
  
  const [updated] = await db
    .update(players)
    .set({
      ...updates,
      updatedAt: new Date(),
    })
    .where(eq(players.userId, session.user.id))
    .returning();
  
  revalidatePath('/dashboard');
  return updated;
}

// åˆ›å»ºåˆå§‹ç©å®¶æ•°æ®
export async function createPlayer(name: string, spiritRoot: string, mindState: string) {
  const session = await auth();
  if (!session?.user?.id) {
    throw new Error('Unauthorized');
  }
  
  const [player] = await db
    .insert(players)
    .values({
      userId: session.user.id,
      name,
      spiritRoot,
      mindState,
    })
    .returning();
  
  return player;
}
```

### æ¸¸æˆé€»è¾‘Server Actions

```typescript
// app/actions/game.ts
'use server';

import { auth } from '@/lib/auth/auth';
import { db } from '@/lib/db';
import { players } from '@/lib/db/schema';
import { eq } from 'drizzle-orm';
import { calculateMaxQi, getRankLabel } from '@/lib/game/calculations';
import { RANK_CONFIG } from '@/lib/game/constants';

// å¢åŠ çµæ°”
export async function gainQi(amount: number) {
  const session = await auth();
  if (!session?.user?.id) return { success: false };
  
  const [player] = await db
    .select()
    .from(players)
    .where(eq(players.userId, session.user.id))
    .limit(1);
  
  if (!player) return { success: false };
  
  const newQi = player.qi + amount;
  
  await db
    .update(players)
    .set({ qi: newQi, updatedAt: new Date() })
    .where(eq(players.userId, session.user.id));
  
  return { success: true, newQi };
}

// å°å¢ƒç•Œçªç ´
export async function minorBreakthrough() {
  const session = await auth();
  if (!session?.user?.id) return { success: false };
  
  const [player] = await db
    .select()
    .from(players)
    .where(eq(players.userId, session.user.id))
    .limit(1);
  
  if (!player) return { success: false };
  
  const nextLevel = player.level + 1;
  const nextMaxQi = calculateMaxQi(player.rank, nextLevel);
  
  await db
    .update(players)
    .set({
      level: nextLevel,
      qi: 0,
      maxQi: nextMaxQi,
      innerDemon: Math.max(0, player.innerDemon - 5),
      updatedAt: new Date(),
    })
    .where(eq(players.userId, session.user.id));
  
  return { success: true, nextLevel };
}

// å¤§å¢ƒç•Œçªç ´
export async function rankBreakthrough() {
  const session = await auth();
  if (!session?.user?.id) return { success: false };
  
  const [player] = await db
    .select()
    .from(players)
    .where(eq(players.userId, session.user.id))
    .limit(1);
  
  if (!player) return { success: false };
  
  const ranks = Object.keys(RANK_CONFIG);
  const currentIndex = ranks.indexOf(player.rank);
  const nextRank = ranks[currentIndex + 1] || 'IMMORTAL';
  const nextMaxQi = calculateMaxQi(nextRank, 1);
  
  await db
    .update(players)
    .set({
      rank: nextRank,
      level: 1,
      qi: 0,
      maxQi: nextMaxQi,
      innerDemon: Math.max(0, player.innerDemon - 30),
      updatedAt: new Date(),
    })
    .where(eq(players.userId, session.user.id));
  
  return { success: true, nextRank };
}
```

---

## ğŸ¤– AIé›†æˆæ–¹æ¡ˆ

### Server Actions + Streaming

```typescript
// app/actions/ai.ts
'use server';

import { google } from '@ai-sdk/google';
import { generateText, generateObject, streamText } from 'ai';
import { createStreamableValue } from 'ai/rsc';
import { z } from 'zod';
import { auth } from '@/lib/auth/auth';

// çµæ ¹è¯„ä»·
export async function generateSpiritRootFeedback(chaosScore: number) {
  await auth(); // ç¡®ä¿å·²è®¤è¯
  
  const { text } = await generateText({
    model: google('gemini-2.0-flash-001'),
    temperature: 0.8,
    maxTokens: 100,
    prompt: `è¯„ä»·çµæ ¹æ··æ²Œåº¦${chaosScore}...`,
  });
  
  return text;
}

// å¤©åŠ«é¢˜ç›®ç”Ÿæˆ
export async function generateTribulationQuiz(rankLabel: string) {
  await auth();
  
  const { object } = await generateObject({
    model: google('gemini-2.0-flash-001'),
    temperature: 0.7,
    schema: z.object({
      questions: z.array(
        z.object({
          question: z.string(),
          options: z.array(z.string()).length(4),
          correctIndex: z.number().min(0).max(3),
        })
      ).length(3)
    }),
    prompt: `ç”Ÿæˆ3é“${rankLabel}å¢ƒç•Œçš„å¤©åŠ«é¢˜ç›®...`,
  });
  
  return object.questions;
}

// æµå¼ä»»åŠ¡ç”Ÿæˆ
export async function streamDailyTasks(rankLabel: string) {
  await auth();
  
  const stream = createStreamableValue();
  
  (async () => {
    const { textStream } = await streamText({
      model: google('gemini-2.0-flash-001'),
      prompt: `ç”Ÿæˆ4ä¸ª${rankLabel}çš„æ‘¸é±¼ä»»åŠ¡...`,
    });
    
    for await (const delta of textStream) {
      stream.update(delta);
    }
    
    stream.done();
  })();
  
  return { output: stream.value };
}
```

---

## ğŸ“¦ å®Œæ•´ä¾èµ–é…ç½®

```json
{
  "name": "xiuxian-nextjs",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "db:generate": "drizzle-kit generate",
    "db:push": "drizzle-kit push",
    "db:studio": "drizzle-kit studio"
  },
  "dependencies": {
    "next": "^15.1.8",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    
    "next-auth": "^5.0.0-beta.25",
    "@auth/drizzle-adapter": "^2.0.0",
    
    "drizzle-orm": "^0.38.0",
    "@vercel/postgres": "^0.10.0",
    "postgres": "^3.4.4",
    
    "ai": "^6.0.0",
    "@ai-sdk/google": "^1.0.0",
    "@ai-sdk/react": "^1.0.0",
    "zod": "^3.22.4",
    
    "zustand": "^5.0.8",
    "@tanstack/react-query": "^5.59.0",
    
    "lucide-react": "^0.553.0",
    "clsx": "^2.1.1",
    "tailwind-merge": "^2.5.2",
    
    "d3": "^7.9.0",
    "@types/d3": "^7.4.3"
  },
  "devDependencies": {
    "typescript": "^5.8.2",
    "@types/node": "^22.14.0",
    "@types/react": "^19.0.2",
    "@types/react-dom": "^19.0.2",
    
    "drizzle-kit": "^0.30.0",
    
    "tailwindcss": "^4.0.0",
    "postcss": "^8.4.47",
    "autoprefixer": "^10.4.20",
    
    "eslint": "^9.16.0",
    "eslint-config-next": "^15.1.8"
  }
}
```

---

## ğŸš€ éƒ¨ç½²æ–¹æ¡ˆ

### Verceléƒ¨ç½²

1. **æ•°æ®åº“**: Vercel Postgres
2. **è®¤è¯**: NextAuth.js + OAuth
3. **AI**: Vercel AI SDK + Gemini API
4. **CDN**: Vercel Edge Network

### ç¯å¢ƒå˜é‡

```bash
# Database
POSTGRES_URL="postgresql://..."
POSTGRES_PRISMA_URL="postgresql://..."
POSTGRES_URL_NO_SSL="postgresql://..."
POSTGRES_URL_NON_POOLING="postgresql://..."

# Auth
NEXTAUTH_SECRET="your-secret"
NEXTAUTH_URL="https://yourdomain.com"

# OAuth Providers
GOOGLE_CLIENT_ID="..."
GOOGLE_CLIENT_SECRET="..."
GITHUB_CLIENT_ID="..."
GITHUB_CLIENT_SECRET="..."

# AI
GOOGLE_GENERATIVE_AI_API_KEY="..."
```

---

## ğŸ“‹ è¿ç§»æ­¥éª¤æ€»ç»“

### Phase 1: åŸºç¡€è®¾æ–½ (Week 1)
1. åˆ›å»ºNext.jsé¡¹ç›®
2. é…ç½®æ•°æ®åº“ (Vercel Postgres + Drizzle)
3. è®¾ç½®NextAuth.jsè®¤è¯
4. éƒ¨ç½²åˆ°Vercel

### Phase 2: æ•°æ®è¿ç§» (Week 2)
1. è®¾è®¡æ•°æ®åº“Schema
2. è¿ç§»æ¸¸æˆæ•°æ®ç»“æ„
3. å®ç°Server Actions API
4. æ•°æ®åŒæ­¥é€»è¾‘

### Phase 3: åŠŸèƒ½å®ç° (Week 3-4)
1. å®ç°ç”¨æˆ·æ³¨å†Œ/ç™»å½•
2. è¿ç§»æ¸¸æˆæ ¸å¿ƒé€»è¾‘
3. é›†æˆVercel AI SDK
4. å®ç°æ’è¡Œæ¦œç³»ç»Ÿ

### Phase 4: æµ‹è¯•ä¼˜åŒ– (Week 5)
1. åŠŸèƒ½æµ‹è¯•
2. æ€§èƒ½ä¼˜åŒ–
3. å®‰å…¨åŠ å›º
4. æ­£å¼å‘å¸ƒ

---

**å®Œæ•´ä»£ç å®ç°è¯·æŸ¥çœ‹é¡¹ç›®æºç **