# 事件流系统测试指南

## 概述

事件流系统是"摸鱼修仙录"的核心玩法，本文档说明如何测试完整的事件流循环。

## 已完成的工作

### 1. 数据结构与Schema ✅
- ✅ 定义了核心接口 (`types/events.ts`)
- ✅ 创建了数据库模型 (`EventLog`, `PlayerStatusEffect`)
- ✅ 运行了数据库迁移

### 2. 事件处理器 ✅
- ✅ 创建了 `features/events/` 模块
- ✅ 实现了 `processEventChoice` Server Action
- ✅ 实现了事件查询和工具函数

### 3. AI集成 ✅
- ✅ 创建了 `lib/ai/generators/event-generator.ts`
- ✅ 实现了 `generateNextEvent` 函数
- ✅ 配置了 Gemini AI 模型

### 4. UI实现 ✅
- ✅ 创建了 `EventDisplay` 组件
- ✅ 创建了事件页面 `/events`
- ✅ 实现了选择处理和结果展示

### 5. 初始事件 ✅
- ✅ 创建了初始事件数据 (`data/events/initial-events.ts`)
- ✅ 包含3个预设事件：初入宗门、第一个任务、神秘前辈

## 测试步骤

### 前置条件

1. 确保数据库正在运行
2. 确保环境变量配置正确（`.env` 文件）
3. 确保已安装所有依赖

### 测试流程

#### 1. 启动开发服务器

```bash
npm run dev
# 或
pnpm dev
```

#### 2. 访问事件页面

打开浏览器访问：`http://localhost:3000/events`

#### 3. 测试事件显示

- 页面应该显示一个事件卡片
- 事件包含标题、描述和选项
- 事件类型标签应该正确显示（重大事件/日常小事/连锁事件）

#### 4. 测试选择处理

1. 点击任意选项
2. 应该看到"处理中..."提示
3. 3秒后应该显示结果（绿色框）
4. 再过3秒应该加载下一个事件

#### 5. 测试AI生成（可选）

当前页面使用AI生成事件。如果AI调用失败，会显示fallback事件。

检查控制台是否有错误信息。

## 当前限制

### 需要后续完善的功能

1. **玩家认证**
   - 当前使用硬编码的 `playerId: 1`
   - 需要集成真实的用户会话

2. **事件持久化**
   - 当前事件只在内存中
   - 需要实现事件缓存机制

3. **选择结果处理**
   - 当前使用mock数据
   - 需要根据 `actionId` 实现真实的逻辑

4. **状态效果系统**
   - 数据库模型已创建
   - 需要实现效果的应用和过期逻辑

5. **事件历史**
   - 可以查询历史记录
   - 需要在UI中展示

## 下一步计划

### V1.1 - 玩法系统融入

1. **将事件流整合到主游戏循环**
   - 在Dashboard中显示当前事件
   - 事件触发与修炼、任务系统联动

2. **实现事件结果处理器**
   - 根据不同的 `actionId` 执行不同逻辑
   - 更新玩家属性、物品、状态效果

3. **事件触发条件**
   - 基于玩家等级、境界触发特定事件
   - 基于时间触发定时事件

### V1.2 - 后期内容扩展

1. **丰富事件库**
   - 添加更多预设事件
   - 创建事件模板系统

2. **事件链系统**
   - 实现多步骤连锁事件
   - 事件分支和多结局

3. **成就系统**
   - 记录特殊事件选择
   - 解锁隐藏事件

## 故障排查

### 常见问题

1. **页面显示"加载中..."不消失**
   - 检查AI API密钥是否配置
   - 查看浏览器控制台错误

2. **点击选项无反应**
   - 检查数据库连接
   - 查看服务端日志

3. **TypeScript错误**
   - 运行 `npx prisma generate`
   - 重启TypeScript服务器

## 技术栈

- **前端**: Next.js 15, React, TailwindCSS
- **后端**: Next.js Server Actions
- **数据库**: PostgreSQL + Prisma
- **AI**: Gemini 2.0 Flash (via Vercel AI SDK)

## 相关文档

- [核心玩法循环](./CORE_GAMEPLAY_LOOP.md)
- [后续开发计划](./FUTURE_DEVELOPMENT_PLAN_V2.md)
- [项目架构](./ARCHITECTURE_DESIGN.md)